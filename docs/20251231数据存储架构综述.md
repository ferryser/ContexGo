# 数据存储架构综述（2025-12-31）

## 1. 背景与目标
本文用于对当前数据存储体系进行重新描述，统一“采集—存储—检索”的边界表达，并明确 L1/L2/L3 的存储职责与演进方向。核心目标是：
- 清晰说明现有 ChronicleGate 的数据落盘结构与写入流程。
- 解释 L1 采集数据与存储接口之间的耦合与边界。
- 给出 L2/L3 扩展时的存储分层与接口演进建议。

## 2. 现有存储结构与写入机制
### 2.1 文件系统分层与日期分桶
当前存储以文件系统为中心，按日期分桶：

- 根目录：`data/chronicle/`
- 子目录：
  - `event/`：原始事件流（JSONL）
  - `metadata/`：结构化元信息（JSON）
  - `blob/`：大对象（二进制）

日期分桶策略：`YYYY-MM-DD`，由 `_resolve_date_bucket` 决定写入路径。

### 2.2 ChronicleGate 写入职责
核心实现位于 `contexgo/chronicle/assembly/chronicle_gate.py`：

- `save_event()`：将事件写入 `event/<date>/<object_id>.jsonl`。
- `_write_metadata()`：将元数据写入 `metadata/<date>/<object_id>.json`。
- `_write_blob()`：将二进制写入 `blob/<date>/<object_id>.<ext>`，并回填 `content_path`。

该设计将事件流、结构化元信息与大对象内容在物理层解耦，便于维护与扩展。

## 3. 接口层与继承结构
### 3.1 BaseChronicle 抽象协议
- 位置：`contexgo/protocol/base_chronicle.py`
- 提供统一的 CRUD 接口与 GraphQL Resolver 适配入口。
- 关键方法：`create/read_by_id/read_by_time_range/read_by_type/update/delete`。

### 3.2 ChronicleGate 具体实现
- 位置：`contexgo/chronicle/assembly/chronicle_gate.py`
- 特性：
  - 通过 `_queue` 与 `_writer_task` 实现异步写入。
  - 事件与元信息分离落盘，减少覆盖风险。
  - blob 独立写入，避免 JSON 膨胀。

目前只有 `ChronicleGate` 实现 `BaseChronicle`，为后续扩展 DBGate、CloudGate 等提供统一接口基础。

## 4. L1 采集层与存储边界
### 4.1 L1 输出结构
- L1 传感器基类：`contexgo/chronicle/base_l1_sensor.py`
- 输出模型：`contexgo/protocol/context.py::RawContextProperties`
- L1 事件以 `content_text`（JSON 字符串）为主要载体，包含 `object_id/create_time/source/content_format` 等元字段。

### 4.2 现有耦合方式
- `save_raw_context()` 接受 `RawContextProperties` 并直接写事件。
- `WindowFocusSensor` 等传感器在 `_capture_impl()` 中直接调用 `save_raw_context()`。
- 事件判定逻辑 `_is_event()` 依赖 `content_type/context_type`，而 L1 默认不强制设置此字段。

结论：L1 与 ChronicleGate 存在“直连式耦合”，尚未形成独立的存储服务层。

## 5. L2/L3 扩展的存储方向
### 5.1 L2（语义层）
当前已有 L2 结构定义：
- `ExtractedData`
- `ProcessedContext`

建议演进路径：
1. 新增 Gate 子类（如 `SemanticGate`）以区分 L2 数据写入目录。
2. 扩展 ChronicleGate，基于 `context_type/content_type` 实现 L2 分区。
3. 引入轻量索引层（向量/实体索引），增强语义检索能力。

### 5.2 L3（认知层）
L3 通常聚合为更高语义对象（任务、意图、叙事）：
- 可引入 `knowledge/` 或 `memo/` 子目录作为高阶对象存储。
- 或对接独立系统（图数据库/向量数据库/知识库）。
- ChronicleGate 保持 L1/L2 的可追溯归档，L3 通过独立存储承接推理与聚合。

## 6. 一致性与风险点
### 6.1 字段一致性
- `object_id`：由 L1 统一生成并贯穿写入流程。
- `create_time`：用于分桶，与 ChronicleGate 逻辑一致。
- `content_type/context_type`：判定逻辑未与 L1 强绑定，需统一策略以减少偏差。

### 6.2 存储形态
- `event` 使用 `.jsonl`，但目前每文件仅一条记录，实际更接近“单条 JSON”。
- `metadata` 单对象存储，未提供版本追踪能力。

### 6.3 API 一致性
GraphQL 目前以 ChronicleGate 为单一数据源，接口更偏向 L1 归档层。若引入 L2/L3 Gate，需要在 API 层明确区分数据入口与查询语义。

## 7. 总结
当前架构已经形成“原始事件归档 + 元信息 + 大对象”三层落盘结构，并通过 ChronicleGate 统一管理写入流程。L1 与存储层仍是工程化直连，下一阶段应通过 Gate 扩展或分层分区策略逐步引入 L2/L3 语义与认知数据，同时完善类型判定与索引体系，以保证跨层存储的一致性与可维护性。
