> ⚠️ Human Only / 仅限人工阅读：此文档仅用于帮助理解现有架构。

# 数据存储架构综述（2025-12-31）

## 1. 文档目的
本文面向人类读者，用于快速建立对当前存储体系的认知：
- 以“现状描述”为主，不做过度推断与设计承诺。
- 说明 ChronicleGate 的实际落盘方式与写入路径。
- 帮助理解 L1/L2/L3 的职责边界与现有耦合方式。

## 2. 现有存储结构（按目录理解）
当前存储以文件系统为中心，按日期分桶组织：

- 根目录：`data/chronicle/`
- 子目录：
  - `event/`：原始事件流（JSONL）
  - `metadata/`：结构化元信息（JSON）
  - `blob/`：大对象（按扩展名存放二进制）

日期分桶策略：`YYYY-MM-DD`，由 `_resolve_date_bucket` 决定写入路径。

## 3. ChronicleGate（当前唯一落盘实现）
核心实现位于 `contexgo/chronicle/assembly/chronicle_gate.py`：

- `save_event()`：写入 `event/<date>/<object_id>.jsonl`。
- `_write_metadata()`：写入 `metadata/<date>/<object_id>.json`。
- `_write_blob()`：写入 `blob/<date>/<object_id>.<ext>` 并回填 `content_path`。

该实现将事件流、元信息与大对象内容在物理层解耦，便于维护与扩展。

## 4. 抽象接口与继承关系
### 4.1 BaseChronicle
- 位置：`contexgo/protocol/base_chronicle.py`
- 角色：提供统一的 CRUD 抽象接口与 GraphQL resolver 入口。
- 关键方法：`create/read_by_id/read_by_time_range/read_by_type/update/delete`。

### 4.2 ChronicleGate
- 位置：`contexgo/chronicle/assembly/chronicle_gate.py`
- 角色：BaseChronicle 的具体实现。
- 特性：
  - 异步 `_queue` + `_writer_task` 实现非阻塞写入。
  - 事件与元信息分开写入，避免 metadata 覆盖事件流。
  - blob 独立写入，避免 JSON 膨胀。

目前只有 `ChronicleGate` 这一种 Gate，实现仍以本地文件系统存储为主。

## 5. L1 采集层与存储边界（现状描述）
### 5.1 L1 输出结构
- L1 传感器基类：`contexgo/chronicle/base_l1_sensor.py`
- 输出模型：`contexgo/protocol/context.py::RawContextProperties`
- L1 事件以 `content_text`（JSON 字符串）作为主要载体，包含 `object_id/create_time/source/content_format` 等字段。

### 5.2 现有耦合方式
- `save_raw_context()` 接受 `RawContextProperties` 并直接写事件。
- `WindowFocusSensor` 等传感器在 `_capture_impl()` 中直接调用 `save_raw_context()`。
- `_is_event()` 依赖 `content_type/context_type` 判定事件类型，而 L1 默认不强制设置此字段。

结论：目前 L1 与 ChronicleGate 仍是直连式耦合，尚未形成独立存储服务层。

## 6. L2/L3 的扩展理解（对现状的延伸说明）
### 6.1 L2（语义层）
`contexgo/protocol/context.py` 已包含：
- `ExtractedData`
- `ProcessedContext`

扩展方向通常包括：
- 引入 Gate 子类（如语义 Gate）以区分 L2 写入目录。
- 在 ChronicleGate 内基于 `context_type/content_type` 做分区写入。
- 引入向量/实体索引以支持语义检索。

### 6.2 L3（认知层）
L3 通常聚合为更高语义对象（任务、意图、叙事）：
- 可新增 `knowledge/` 或 `memo/` 子目录。
- 或接入图数据库、向量数据库等独立系统。
- ChronicleGate 保持 L1/L2 可追溯归档，L3 负责推理与聚合结果。

## 7. 一致性与注意点
### 7.1 字段一致性
- `object_id`：由 L1 统一生成并贯穿写入流程。
- `create_time`：用于分桶，与 ChronicleGate 逻辑一致。
- `content_type/context_type`：判定逻辑未与 L1 强绑定，需统一策略以减少偏差。

### 7.2 存储形态
- `event` 使用 `.jsonl`，但目前每文件仅一条记录，实际更接近“单条 JSON”。
- `metadata` 单对象存储，未提供版本追踪能力。

### 7.3 API 一致性
GraphQL 目前以 ChronicleGate 为单一数据源，接口语义更偏向 L1 归档层。若引入 L2/L3 Gate，需要在 API 层明确区分数据入口与查询语义。

## 8. 小结
当前架构已形成“原始事件归档 + 元信息 + 大对象”三层落盘结构，并由 ChronicleGate 统一管理写入流程。文档目的在于帮助读者建立对现有系统的理解，为后续扩展提供明确的现实基线。
